var data = [[5.1,3.5,1.4,0.2],[4.9,3,1.4,0.2],[4.7,3.2,1.3,0.2],[4.6,3.1,1.5,0.2],[5,3.6,1.4,0.2],[5.4,3.9,1.7,0.4],[4.6,3.4,1.4,0.3],[5,3.4,1.5,0.2],[4.4,2.9,1.4,0.2],[4.9,3.1,1.5,0.1],[5.4,3.7,1.5,0.2],[4.8,3.4,1.6,0.2],[4.8,3,1.4,0.1],[4.3,3,1.1,0.1],[5.8,4,1.2,0.2],[5.7,4.4,1.5,0.4],[5.4,3.9,1.3,0.4],[5.1,3.5,1.4,0.3],[5.7,3.8,1.7,0.3],[5.1,3.8,1.5,0.3],[5.4,3.4,1.7,0.2],[5.1,3.7,1.5,0.4],[4.6,3.6,1,0.2],[5.1,3.3,1.7,0.5],[4.8,3.4,1.9,0.2],[5,3,1.6,0.2],[5,3.4,1.6,0.4],[5.2,3.5,1.5,0.2],[5.2,3.4,1.4,0.2],[4.7,3.2,1.6,0.2],[4.8,3.1,1.6,0.2],[5.4,3.4,1.5,0.4],[5.2,4.1,1.5,0.1],[5.5,4.2,1.4,0.2],[4.9,3.1,1.5,0.1],[5,3.2,1.2,0.2],[5.5,3.5,1.3,0.2],[4.9,3.1,1.5,0.1],[4.4,3,1.3,0.2],[5.1,3.4,1.5,0.2],[5,3.5,1.3,0.3],[4.5,2.3,1.3,0.3],[4.4,3.2,1.3,0.2],[5,3.5,1.6,0.6],[5.1,3.8,1.9,0.4],[4.8,3,1.4,0.3],[5.1,3.8,1.6,0.2],[4.6,3.2,1.4,0.2],[5.3,3.7,1.5,0.2],[5,3.3,1.4,0.2],[7,3.2,4.7,1.4],[6.4,3.2,4.5,1.5],[6.9,3.1,4.9,1.5],[5.5,2.3,4,1.3],[6.5,2.8,4.6,1.5],[5.7,2.8,4.5,1.3],[6.3,3.3,4.7,1.6],[4.9,2.4,3.3,1],[6.6,2.9,4.6,1.3],[5.2,2.7,3.9,1.4],[5,2,3.5,1],[5.9,3,4.2,1.5],[6,2.2,4,1],[6.1,2.9,4.7,1.4],[5.6,2.9,3.6,1.3],[6.7,3.1,4.4,1.4],[5.6,3,4.5,1.5],[5.8,2.7,4.1,1],[6.2,2.2,4.5,1.5],[5.6,2.5,3.9,1.1],[5.9,3.2,4.8,1.8],[6.1,2.8,4,1.3],[6.3,2.5,4.9,1.5],[6.1,2.8,4.7,1.2],[6.4,2.9,4.3,1.3],[6.6,3,4.4,1.4],[6.8,2.8,4.8,1.4],[6.7,3,5,1.7],[6,2.9,4.5,1.5],[5.7,2.6,3.5,1],[5.5,2.4,3.8,1.1],[5.5,2.4,3.7,1],[5.8,2.7,3.9,1.2],[6,2.7,5.1,1.6],[5.4,3,4.5,1.5],[6,3.4,4.5,1.6],[6.7,3.1,4.7,1.5],[6.3,2.3,4.4,1.3],[5.6,3,4.1,1.3],[5.5,2.5,4,1.3],[5.5,2.6,4.4,1.2],[6.1,3,4.6,1.4],[5.8,2.6,4,1.2],[5,2.3,3.3,1],[5.6,2.7,4.2,1.3],[5.7,3,4.2,1.2],[5.7,2.9,4.2,1.3],[6.2,2.9,4.3,1.3],[5.1,2.5,3,1.1],[5.7,2.8,4.1,1.3],[6.3,3.3,6,2.5],[5.8,2.7,5.1,1.9],[7.1,3,5.9,2.1],[6.3,2.9,5.6,1.8],[6.5,3,5.8,2.2],[7.6,3,6.6,2.1],[4.9,2.5,4.5,1.7],[7.3,2.9,6.3,1.8],[6.7,2.5,5.8,1.8],[7.2,3.6,6.1,2.5],[6.5,3.2,5.1,2],[6.4,2.7,5.3,1.9],[6.8,3,5.5,2.1],[5.7,2.5,5,2],[5.8,2.8,5.1,2.4],[6.4,3.2,5.3,2.3],[6.5,3,5.5,1.8],[7.7,3.8,6.7,2.2],[7.7,2.6,6.9,2.3],[6,2.2,5,1.5],[6.9,3.2,5.7,2.3],[5.6,2.8,4.9,2],[7.7,2.8,6.7,2],[6.3,2.7,4.9,1.8],[6.7,3.3,5.7,2.1],[7.2,3.2,6,1.8],[6.2,2.8,4.8,1.8],[6.1,3,4.9,1.8],[6.4,2.8,5.6,2.1],[7.2,3,5.8,1.6],[7.4,2.8,6.1,1.9],[7.9,3.8,6.4,2],[6.4,2.8,5.6,2.2],[6.3,2.8,5.1,1.5],[6.1,2.6,5.6,1.4],[7.7,3,6.1,2.3],[6.3,3.4,5.6,2.4],[6.4,3.1,5.5,1.8],[6,3,4.8,1.8],[6.9,3.1,5.4,2.1],[6.7,3.1,5.6,2.4],[6.9,3.1,5.1,2.3],[5.8,2.7,5.1,1.9],[6.8,3.2,5.9,2.3],[6.7,3.3,5.7,2.5],[6.7,3,5.2,2.3],[6.3,2.5,5,1.9],[6.5,3,5.2,2],[6.2,3.4,5.4,2.3],[5.9,3,5.1,1.8]];
var kmeans = null;
var xAxisIndex = 0;
var yAxisIndex = 1;
var zAxisIndex = 2;
var plotlyLayout = {
    autosize: true,
    showlegend: false,
    margin: {
        l: 0,
        r: 0,
        b: 0,
        t: 0,
        pad: 0
    },

    scene: {
        aspectratio: {
            x: 1,
            y: 1,
            z: 1
        },
        camera: {
            center: { x: 0, y: 0, z: 0 },
            eye: { x: 1.5, y: 1.5, z: 0.15 },
            up: { x: 0, y: 0, z: 1 }
        },
        xaxis: {
            title: 'Sepal length',
            type: 'linear',
            zeroline: false
        },
        yaxis: {
            title: 'Sepal width',
            type: 'linear',
            zeroline: false
        },
        zaxis: {
            title: 'Petal length',
            type: 'linear',
            zeroline: false
        }
    }
};
var plotlyData = [
    {
        x: [],
        y: [],
        z: [],
        mode: 'markers',
        type: 'scatter3d',
        name: 'points',
        marker: {
            color: 'rgb(23, 190, 207)',
            size: 2
        }
    },
    {
        x: [],
        y: [],
        z: [],
        mode: 'markers',
        type: 'scatter3d',
        name: 'centeroids',
        marker: {
            color: 'rgb(255, 10, 10)',
            // color: 'rgb(23, 190, 207)',
            size: 3
        }
    },
    {
        alphahull: 0,
        opacity: 0.1,
        type: 'mesh3d',
        x: [],
        y: [],
        z: []
    },
    {
        alphahull: 0,
        opacity: 0.1,
        type: 'mesh3d',
        x: [],
        y: [],
        z: []
    },
    {
        alphahull: 0,
        opacity: 0.1,
        type: 'mesh3d',
        x: [],
        y: [],
        z: []
    }
];
var plotlyInited = false;
var xAxisSelect = document.getElementById('xAxisSelect');
var yAxisSelect = document.getElementById('yAxisSelect');
var zAxisSelect = document.getElementById('zAxisSelect');
var resetButton = document.getElementById('reset');
var iterateButton = document.getElementById('iterate');
var runButton = document.getElementById('run');
var resultElement = document.getElementById('result');

// Start
reset();


/**
 * Funtions
 */
function reset() {
    kmeans = KMeans({data: data, k: 3});
    log();
    draw();
}


function iterate() {
    kmeans = KMeans.iterate(kmeans);
    log();
    draw();
}


function run() {
    KMeans.runAnimation(kmeans, 500, function(isEnded, kmeans_) {
        if (isEnded) console.log('ENDED');
        kmeans = kmeans_;
        log();
        draw();
    });
}


function draw() {
    if (!kmeans) return;

    plotlyData[0].x = unpack(kmeans.data, xAxisIndex);
    plotlyData[0].y = unpack(kmeans.data, yAxisIndex);
    plotlyData[0].z = unpack(kmeans.data, zAxisIndex);

    plotlyData[1].x = unpack(kmeans.centeroids, xAxisIndex);
    plotlyData[1].y = unpack(kmeans.centeroids, yAxisIndex);
    plotlyData[1].z = unpack(kmeans.centeroids, zAxisIndex);

    plotlyData[2].x = unpack(kmeans.classes['0'], xAxisIndex);
    plotlyData[2].y = unpack(kmeans.classes['0'], yAxisIndex);
    plotlyData[2].z = unpack(kmeans.classes['0'], zAxisIndex);

    plotlyData[3].x = unpack(kmeans.classes['1'], xAxisIndex);
    plotlyData[3].y = unpack(kmeans.classes['1'], yAxisIndex);
    plotlyData[3].z = unpack(kmeans.classes['1'], zAxisIndex);

    plotlyData[4].x = unpack(kmeans.classes['2'], xAxisIndex);
    plotlyData[4].y = unpack(kmeans.classes['2'], yAxisIndex);
    plotlyData[4].z = unpack(kmeans.classes['2'], zAxisIndex);

    if (plotlyInited) {
        Plotly.redraw('visualization');
    } else {
        Plotly.newPlot('visualization', plotlyData, plotlyLayout, {
            displayModeBar: false,
            responsive: true,
        });
        plotlyInited = true;
    }
}


function log() {
    resultElement.innerHTML =
        'Iteration: ' + kmeans.iteration + '<br/>' +
        '<br/>' +
        'Class #1: ' + kmeans.classes['0'].length + '<br/>' +
        'Class #2: ' + kmeans.classes['1'].length + '<br/>' +
        'Class #3: ' + kmeans.classes['2'].length + '<br/>';
}


function unpack(rows, key) {
    return rows.map(function(row) { return row[key]; });
}

/**
 * Event listeners
 */
xAxisSelect.addEventListener('change', function() {
    xAxisIndex = parseInt(xAxisSelect.value, 10);
    draw();
});
yAxisSelect.addEventListener('change', function() {
    yAxisIndex = parseInt(xAxisSelect.value, 10);
    draw();
});
zAxisSelect.addEventListener('change', function() {
    xAxisIndex = parseInt(zAxisSelect.value, 10);
    draw();
});
resetButton.addEventListener('click', reset);
iterateButton.addEventListener('click', iterate);
runButton.addEventListener('click', run);
